<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="stylesheet" href="main.css">
    <meta charset="UTF-8">
    <title>ניהול משרד גלביט הנדסה</title>
        <!-- One-time purge of legacy localStorage clients list -->
        <script>
            (function(){
                try {
                    if(!localStorage.getItem('__clients_purged_v1')) {
                        localStorage.removeItem('clients');
                        localStorage.setItem('__clients_purged_v1','1');
                        console.log('[purge] removed legacy clients list from localStorage');
                    }
                } catch(e) { /* ignore */ }
            })();
        </script>
    <script type="module" src="frontend/modules/saveIndicator.js?v=1"></script>
    <script type="module" src="frontend/modules/disableLocalStorage.js?v=1"></script>
    <script type="module" src="frontend/modules/projectTable.js?v=2"></script>
    <script type="module" src="frontend/modules/unsynced.js"></script>
    <script type="module" src="frontend/modules/productionTracking.js"></script>
    <!-- Added version query to bust browser cache for journalUI.js -->
    <script type="module" src="frontend/modules/journalUI.js?v=8"></script>
    <!-- BUILD_MARKER: journal_board_notes_removed v2 (2025-09-10T15:00Z) -->
    <!-- Live reload (dev only - safe no-op in prod if endpoint missing) -->
    <script>
        (function(){
            if(location.hostname==='localhost' || location.hostname==='127.0.0.1'){
                try {
                    const es = new EventSource('/__livereload');
                    es.addEventListener('reload', ()=>{ console.log('[live-reload] change detected -> reload'); location.reload(); });
                } catch(e){ console.warn('live-reload init failed', e); }
            }
        })();
    </script>
    <style>
        :root {
            --main-bg: #eaf6fb;
            --container-bg: #ffffff;
            --primary: #4fc3f7;
            --primary-dark: #039be5;
            --primary-light: #b3e5fc;
            --tab-active: #e3f2fd;
            --tab-inactive: #b3e5fc33;
            --border: #b3e5fc;
            --text: #1a3557;
            --shadow: 0 2px 12px #4fc3f722;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--main-bg);
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: var(--container-bg);
            padding: 16px 0 0 0; /* ללא ריפוד צדדי כדי לאפשר לטבלאות להתפרס על כל הרוחב */
            border-radius: 0;
            box-shadow: none;
        }
        h1 {
            text-align: center;
            color: var(--primary-dark);
            font-size: 2.3em;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 28px;
            background: var(--tab-inactive);
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 14px 0;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.13em;
            color: var(--text);
            transition: background 0.2s, color 0.2s;
            font-weight: 500;
        }
        .tab.active {
            background: var(--tab-active);
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
        }
        .tab:not(.active):hover {
            background: var(--primary-light);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadein 0.3s;
            padding: 0 8px; /* מעט מרווח לצדדים בלי לפגוע ברוחב הטבלאות */
        }
        @keyframes fadein {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px;
            background: #fafdff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 6px #4fc3f71a;
        }
        /* Project tables column sizing & overflow control */
        #projects-table-active, #projects-table-done { table-layout: auto; }
        #projects-table-active th:nth-child(1), #projects-table-active td:nth-child(1),
        #projects-table-done th:nth-child(1), #projects-table-done td:nth-child(1) {
            width: 85px; max-width: 90px; white-space: nowrap; }
        /* Clip long text in first textual columns */
        #projects-table-active th:nth-child(2), #projects-table-active td:nth-child(2),
        #projects-table-active th:nth-child(3), #projects-table-active td:nth-child(3),
        #projects-table-active th:nth-child(4), #projects-table-active td:nth-child(4),
        #projects-table-done th:nth-child(2), #projects-table-done td:nth-child(2),
        #projects-table-done th:nth-child(3), #projects-table-done td:nth-child(3),
        #projects-table-done th:nth-child(4), #projects-table-done td:nth-child(4) {
            max-width: 190px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* Inputs & selects inside project tables: no overflow, compact padding */
        #projects-table-active td input[type=text], #projects-table-active td select,
        #projects-table-done td input[type=text], #projects-table-done td select {
            box-sizing: border-box; padding: 2px 4px; margin: 0; width: 100%; font-size: 0.92em; }
        /* Ensure negative status wrappers stretch full cell width */
        #projects-table-active td .neg-color-wrap, #projects-table-done td .neg-color-wrap { width: 100% !important; display: block; }
        /* Prevent buttons row from stretching cell undesirably */
        #projects-table-active td:last-child .row-actions, #projects-table-done td:last-child .row-actions { justify-content: center; }
        /* Slightly reduce overall cell horizontal padding to gain space */
        #projects-table-active td, #projects-table-done td { padding-left:4px; padding-right:4px; }
        /* LTR alignment for date input so numbers align nicely */
        #projects-table-active td:nth-child(1) input[type=text], #projects-table-done td:nth-child(1) input[type=text] { direction:ltr; text-align:center; }
        th, td {
            border: 1px solid var(--border);
            padding: 0 6px; /* גובה מינימלי לשורות */
            text-align: center;
            font-size: 1em;
            line-height: 1.15;
        }
    tr.child-row td { padding: 2px 4px; font-size: 0.92em; line-height:1.05; }
    tr.parent-row td { background:#f5faff; font-weight:500; }
    /* Board notes column & styles removed (see BUILD_MARKER) */
        th {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 600;
            padding: 2px 6px;
        }
        tr:nth-child(even) {
            background: #eaf6fb;
        }
        tr:nth-child(odd) {
            background: #fafdff;
        }
        .add-row-btn {
            margin: 15px 0 0 0;
            padding: 10px 28px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-size: 1.08em;
            font-weight: 500;
            box-shadow: 0 1px 4px #4fc3f722;
            transition: background 0.2s;
        }
        .add-row-btn:hover {
            background: var(--primary-dark);
        }
        select, input[type="text"] {
            width: 100%;
            padding: 7px 5px;
            border-radius: 5px;
            border: 1px solid var(--border);
            font-size: 1em;
            background: #fafdff;
            margin-bottom: 4px;
        }
        input[type="checkbox"] {
            transform: scale(1.25);
            accent-color: var(--primary);
        }
        button {
            font-family: inherit;
        }
    td .action-btn { margin:0 1px; width:28px; height:28px; border-radius:6px; border:1px solid #cfd8dc; background:#fff; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; font-size:15px; line-height:1; padding:0; transition:background .15s,border-color .15s; }
    td .action-btn:hover { background:#e3f2fd; border-color:#90caf9; }
    td .action-btn.edit-btn { color:#1976d2; }
    td .action-btn.delete-btn { color:#d32f2f; }
    td .action-btn.duplicate-btn { color:#388e3c; }
        dialog {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 24px #4fc3f744;
            padding: 24px 30px 18px 30px;
            background: #fafdff;
            min-width: 340px;
        }
        dialog::backdrop {
            background: #4fc3f733;
        }
        #project-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 1em;
        }
        #project-form input[type="text"] {
            margin-bottom: 0;
        }
        #project-form menu {
            margin-top: 18px;
        }
        #project-form button[type="submit"] {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 7px 18px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        #project-form button[type="submit"]:hover {
            background: var(--primary-dark);
        }
        #project-form button[type="button"] {
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 6px;
            padding: 7px 18px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        #project-form button[type="button"]:hover {
            background: #bdbdbd;
        }
    /* Parent-Child hierarchy styling */
    tr.parent-row td { background: #f8fafc; border-top: 2px solid #e2e8f0; }
    .parent-bar { display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .parent-bar .sep { color: #94a3b8; }
    .parent-bar .muted { color: #64748b; }
    .parent-bar .flex { flex: 1 1 auto; }
    .collapse-btn { border: 1px solid #cbd5e1; background: #fff; border-radius: 6px; padding: 2px 6px; cursor: pointer; }
    tr.child-row td:first-child { padding-right: 18px; }
    </style>
</head>
<body>
    <!-- LEGACY_FORM הוסר: הטופס מנוהל במודולים -->
    <script type="module" src="frontend/main.js?v=2"></script>
    <div class="container">
        <h1>ניהול משרד גלביט הנדסה</h1>
        <div style="position:fixed;top:10px;right:14px;z-index:9999;display:flex;gap:8px;flex-wrap:wrap;">
            <button id="clients-admin-btn" style="background:#455a64;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:500;box-shadow:0 2px 8px #0002;">רשימת לקוחות</button>
            <button id="workers-admin-btn" style="background:#546e7a;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:500;box-shadow:0 2px 8px #0002;">רשימת עובדים</button>
        </div>
    <!-- Live test button removed per request -->
                <div class="tabs">
                        <button class="tab active" onclick="showTab(0)">מעקב פרויקטים</button>
                        <button class="tab" onclick="showTab(1)">יומן משימות</button>
                        <button class="tab" onclick="showTab(2)">מעקב ייצור</button>
                        <button class="tab" onclick="showTab(3)">פרויקטים שהסתיימו</button>
                </div>
                <!-- TAB 0: מעקב פרויקטים (Active) -->
                <div class="tab-content active" id="tab-0">
                    <div style="margin-top:16px;">
                        <button class="add-row-btn" onclick="openProjectDialog()">הוסף פרויקט</button>
                    </div>
                    <table id="projects-table-active">
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>שם לקוח</th>
                                <th>שם פרוייקט</th>
                                <th>שם לוח</th>
                                <th>שם עובד</th>
                                <th>סטטוס</th>
                                <th>סטטוס שלילי</th>
                                <th>סטטוס שלילי 2</th>
                                <th>סטטוס שלילי 3</th>
                                <th>הערות</th>
                                <th>טופל</th>
                                <th>נמסר</th>
                                <th>הסתיים</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- TAB 1: יומן משימות -->
                <div class="tab-content" id="tab-1">
                    <!-- Journal Subtabs -->
                    <div id="journal-subtabs" style="margin-bottom:16px;display:flex;gap:8px;align-items:center">
                        <button class="journal-subtab-btn" data-worker="all" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">הכל</button>
                        <button class="journal-subtab-btn" data-worker="לידור" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">לידור</button>
                        <button class="journal-subtab-btn" data-worker="ספיר" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">ספיר</button>
                        <button class="journal-subtab-btn" data-worker="מתן" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">מתן</button>
                        <button class="journal-subtab-btn" data-worker="done" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">משימות שבוצעו</button>
                    </div>
                    <table id="tasks-journal-table">
            <thead>
                <tr>
                    <th>תאריך</th>
                    <th>שם לקוח</th>
                    <th>שם פרויקט</th>
                    <th>שם לוח</th>
                    <th>כמות</th>
                    <th>מספר עבודה /תכנית</th>
                    <th>הערות ללוח</th>
                    <th>שרטוט</th>
                    <th>מדבקות</th>
                    <th>מהדקים</th>
                    <th>גידים</th>
                    <th>שלטים</th>
                    <th>הרכבה</th>
                    <th>AM</th>
                </tr>
            </thead>
            <tbody></tbody>
                                </table>
                            </div>
                            <!-- TAB 2: מעקב ייצור -->
                            <div class="tab-content" id="tab-2">
                                <table id="production-tracking-table">
                <thead>
                    <tr>
                        <th>תאריך</th>
                        <th>שם לקוח</th>
                        <th>שם פרויקט</th>
                        <th>עובד</th>
                        <th>סטטוס</th>
                        <th>סטטוס מבנה</th>
                        <th>סטטוס ציוד</th>
                        <th>סטטוס הרכבה</th>
                        <th>סטטוס חיווט</th>
                        <th>סטטוס בדיקה</th>
                    </tr>
                </thead>
                <tbody></tbody>
                    </table>
                </div>
            <!-- TAB 3: פרויקטים שהסתיימו -->
            <div class="tab-content" id="tab-3">
                    <table id="projects-table-done">
                <thead>
                    <tr>
                        <th>תאריך</th>
                        <th>שם לקוח</th>
                        <th>שם פרוייקט</th>
                        <th>שם עובד</th>
                        <th>סטטוס</th>
                        <th>סטטוס שלילי</th>
                        <th>סטטוס שלילי 2</th>
                        <th>סטטוס שלילי 3</th>
                        <th>הערות</th>
                        <th>טופל</th>
                        <th>נמסר</th>
                        <th>הסתיים</th>
                        <th>פעולות</th>
                    </tr>
                </thead>
                <tbody></tbody>
                    </table>
        </div>
                <!-- Project Dialog -->
                <dialog id="project-dialog">
                    <h3 id="dialog-title" style="margin-top:0">הוסף פרויקט</h3>
                    <form id="project-form" method="dialog">
                        <label>מס הזמנה
                            <input type="text" name="orderId" required>
                        </label>
                        <label>לקוח
                            <select id="dialog-client" name="client" required></select>
                        </label>
                        <label>שם פרויקט
                            <input type="text" name="projectName" required>
                        </label>
                        <label>שם לוח
                            <input type="text" name="boardName">
                        </label>
                                    <label>כמות לוחות
                                        <input type="number" name="quantity" id="dialog-quantity" min="1" value="1">
                                    </label>
                        <label>עובד
                            <select id="dialog-worker" name="worker"></select>
                        </label>
                        <label>סטטוס
                            <select id="dialog-status" name="status"></select>
                        </label>
                        <label>סטטוס שלילי
                            <select id="dialog-neg1" name="neg1"></select>
                        </label>
                        <label>סטטוס שלילי 2
                            <select id="dialog-neg2" name="neg2"></select>
                        </label>
                        <label>סטטוס שלילי 3
                            <select id="dialog-neg3" name="neg3"></select>
                        </label>
                        <label>הערות
                            <input type="text" name="notes">
                        </label>
                        <menu style="display:flex;gap:12px;justify-content:flex-start;margin:18px 0 0 0;padding:0;">
                            <button id="dialog-save" value="default" type="submit">הוסף</button>
                            <button type="button" onclick="closeProjectDialog()">סגור</button>
                        </menu>
                    </form>
                </dialog>
    </div>
    <script>
        // רשימת לקוחות סטטית הוסרה – כעת נטען רק מהשרת (Docker API) דרך main.js loadReference()
        // השארת מערכי ברירת מחדל ריקים עד להגעת הנתונים מהשרת.
        window.PROJECT_CLIENTS = [];
        // השארת עובדים/סטטוסים רק כ-fallback רפוי. ניתן להסיר גם אותם בעתיד אם תרצה.
    // רשימת עובדים סטטית הוסרה – כעת נטען רק מהשרת (backend reference). משאירים ריק עד שהנתונים יגיעו.
    window.PROJECT_WORKERS = [];
        window.PROJECT_STATUS_OPTIONS = window.PROJECT_STATUS_OPTIONS || ["הזמנה חדשה","בתכנון","בשרטוט","באישור לקוח","ממתין לשיבוץ","בייצור","בבדיקה","ממתין לאיסוף"]; 
        window.PROJECT_NEGATIVE_STATUSES = window.PROJECT_NEGATIVE_STATUSES || ["חסר ציוד","חסר מבנה","חסר שילוט","כשלים בבדיקה","ממתין ל AM"]; 
        document.addEventListener('DOMContentLoaded', () => {
            // טעינת פרויקטים מקומית (אם קיימת) – עדיין מופעלת רק אם הפונקציה קיימת
            if (typeof window.loadProjectsFromStorage === 'function') {
                try { window.loadProjectsFromStorage(); } catch(e){ console.warn('loadProjectsFromStorage failed', e); }
            }
            // Removed forced showTab(0) to allow legacyProjectUI.js restore logic (__main_activeTab)
            if (typeof window.showTab === 'function') {
                try {
                    const saved = parseInt(localStorage.getItem('__main_activeTab')||'0',10);
                    window.showTab(isNaN(saved)?0:saved);
                } catch(_) { window.showTab(0); }
            }
        });
    </script>
    <script type="module" src="frontend/modules/legacyProjectUI.js?v=2"></script>
    <dialog id="clients-admin-dialog" style="min-width:460px">
        <h3 style="margin-top:0">ניהול לקוחות</h3>
        <div style="display:flex;gap:6px;margin-bottom:10px;">
            <input id="new-client-name" type="text" placeholder="שם לקוח חדש" style="flex:1;padding:6px" />
            <button id="add-client-btn" style="background:#1976d2;color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;">הוסף</button>
        </div>
        <div style="max-height:320px;overflow:auto;border:1px solid #ccc;padding:6px;border-radius:6px;" id="clients-list-box">
            <div style="text-align:center;color:#888;font-size:.9em">טוען...</div>
        </div>
        <menu style="margin-top:14px;display:flex;justify-content:flex-end;gap:10px;padding:0;">
            <button id="export-clients-btn" type="button">ייצוא לקובץ</button>
            <button id="close-clients-btn" type="button">סגור</button>
        </menu>
        <p id="clients-admin-msg" style="font-size:.8em;color:#666;margin:6px 0 0 0;"></p>
    </dialog>
    <dialog id="workers-admin-dialog" style="min-width:460px">
        <h3 style="margin-top:0">ניהול עובדים</h3>
        <div style="display:flex;gap:6px;margin-bottom:10px;">
            <input id="new-worker-name" type="text" placeholder="שם עובד חדש" style="flex:1;padding:6px" />
            <button id="add-worker-btn" style="background:#1976d2;color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;">הוסף</button>
        </div>
        <div style="max-height:320px;overflow:auto;border:1px solid #ccc;padding:6px;border-radius:6px;" id="workers-list-box">
            <div style="text-align:center;color:#888;font-size:.9em">טוען...</div>
        </div>
        <menu style="margin-top:14px;display:flex;justify-content:flex-end;gap:10px;padding:0;">
            <button id="export-workers-btn" type="button">ייצוא לקובץ</button>
            <button id="close-workers-btn" type="button">סגור</button>
        </menu>
        <p id="workers-admin-msg" style="font-size:.8em;color:#666;margin:6px 0 0 0;"></p>
    </dialog>
    <script>
    (function(){
        const dlg = document.getElementById('clients-admin-dialog');
        const btn = document.getElementById('clients-admin-btn');
        const listBox = document.getElementById('clients-list-box');
        const addBtn = document.getElementById('add-client-btn');
        const newInput = document.getElementById('new-client-name');
        const closeBtn = document.getElementById('close-clients-btn');
        const exportBtn = document.getElementById('export-clients-btn');
        const msg = document.getElementById('clients-admin-msg');
        // --- Admin token handling (no hardcoded secret) ---
        function getToken(){ return sessionStorage.getItem('__admin_token') || ''; }
        function setToken(t){ if(t) sessionStorage.setItem('__admin_token', t); }
        async function ensureToken(){
            let tk = getToken();
            if(!tk){
                tk = prompt('הזן אסימון מנהל (ADMIN_TOKEN)');
                if(tk) setToken(tk);
            }
            return tk;
        }
        // Show button only if backend exposed admin flag OR user already entered token.
    function maybeShowButton(){ btn.style.display='inline-block'; }
        maybeShowButton();
    // Attempt to load admin flag (two paths); purely informational now
    ['\/admin-flag.js','\/api\/admin-flag.js'].forEach(src=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>console.debug('[admin-flag] loaded',src); s.onerror=()=>console.debug('[admin-flag] failed',src); document.head.appendChild(s); });

        function note(t,c){ msg.textContent=t; msg.style.color=c||'#666'; }
        async function fetchClients(){
            listBox.innerHTML = '<div style="text-align:center;color:#888;font-size:.9em">טוען...</div>';
            try {
                const r = await fetch('/api/clients');
                if(!r.ok) throw new Error(r.status);
                const data = await r.json();
                const arr = (data.clients||[]).slice();
                listBox.innerHTML = arr.map(c=>`<div data-name="${c.name.replace(/"/g,'&quot;')}" data-id="${c.id||''}" style="display:flex;align-items:center;gap:6px;padding:4px 2px;border-bottom:1px solid #eee;">`+
                    `<span style="flex:1;overflow:hidden;text-overflow:ellipsis;direction:rtl">${c.name}</span>`+
                    `<button class="del-client" data-id="${c.id||''}" data-name="${c.name}" style="background:#d32f2f;color:#fff;border:none;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:.75em;">מחק</button>`+
                `</div>`).join('');
            } catch(e){ listBox.innerHTML = '<div style="color:#d32f2f;text-align:center">שגיאה בטעינה</div>'; }
        }
        async function addClient(){
            const name = newInput.value.trim();
            if(!name){ note('חובה להזין שם', '#d32f2f'); return; }
            note('שומר...');
            try {
                const token = await ensureToken(); if(!token){ note('לא הוזן אסימון', '#d32f2f'); return; }
                const r = await fetch('/api/clients',{method:'POST', headers:{'Content-Type':'application/json','x-admin-token':token}, body: JSON.stringify({ name })});
                if(!r.ok) throw new Error(r.status);
                newInput.value=''; await fetchClients(); note('נוסף', '#2e7d32');
                document.dispatchEvent(new Event('refdata:refresh-requested'));
            } catch(e){
                if(e.message==='403') { sessionStorage.removeItem('__admin_token'); note('אסימון שגוי', '#d32f2f'); }
                else note('נכשל בהוספה', '#d32f2f');
            }
        }
        async function delClient(el){
            const name = el.dataset.name; const id = el.dataset.id;
            if(!confirm('למחוק לקוח? '+name)) return;
            note('מוחק...');
            try {
                const token = await ensureToken(); if(!token){ note('לא הוזן אסימון', '#d32f2f'); return; }
                const r = await fetch('/api/clients/'+ encodeURIComponent(id||name), { method:'DELETE', headers:{'x-admin-token':token}});
                if(!r.ok) throw new Error(r.status);
                await fetchClients(); note('נמחק', '#2e7d32');
                document.dispatchEvent(new Event('refdata:refresh-requested'));
            } catch(e){
                if(e.message==='403') { sessionStorage.removeItem('__admin_token'); note('אסימון שגוי', '#d32f2f'); }
                else note('מחיקה נכשלה', '#d32f2f');
            }
        }
        async function exportSnapshot(){
            note('מייצא...');
            try {
                const token = await ensureToken(); if(!token){ note('לא הוזן אסימון', '#d32f2f'); return; }
                const r = await fetch('/api/clients/export',{method:'POST', headers:{'x-admin-token':token}});
                if(!r.ok) throw new Error(r.status);
                note('נשמר לקובץ (clients.json)', '#2e7d32');
            } catch(e){
                if(e.message==='403') { sessionStorage.removeItem('__admin_token'); note('אסימון שגוי', '#d32f2f'); }
                else note('ייצוא נכשל', '#d32f2f');
            }
        }
        btn?.addEventListener('click', ()=>{ dlg.showModal(); fetchClients(); });
        addBtn?.addEventListener('click', addClient);
        newInput?.addEventListener('keydown', e=>{ if(e.key==='Enter') addClient(); });
        closeBtn?.addEventListener('click', ()=> dlg.close());
        exportBtn?.addEventListener('click', exportSnapshot);
        listBox?.addEventListener('click', e=>{ const b = e.target.closest('.del-client'); if(b) delClient(b); });
        // Optional external refresh trigger
        document.addEventListener('refdata:refresh-requested', async ()=>{
            try { const ref = await window.apiLayer?.loadReference?.(); if(ref?.clients){ window.clients = ref.clients.map(c=>c.name); } } catch(_){ }
        });
    })();
    (function(){
        const dlg = document.getElementById('workers-admin-dialog');
        const btn = document.getElementById('workers-admin-btn');
        const listBox = document.getElementById('workers-list-box');
        const addBtn = document.getElementById('add-worker-btn');
        const newInput = document.getElementById('new-worker-name');
        const closeBtn = document.getElementById('close-workers-btn');
        const exportBtn = document.getElementById('export-workers-btn');
        const msg = document.getElementById('workers-admin-msg');
        function getToken(){ return sessionStorage.getItem('__admin_token') || ''; }
        function setToken(t){ if(t) sessionStorage.setItem('__admin_token', t); }
        async function ensureToken(){ let tk=getToken(); if(!tk){ tk=prompt('הזן אסימון מנהל (ADMIN_TOKEN)'); if(tk) setToken(tk);} return tk; }
        function note(t,c){ msg.textContent=t; msg.style.color=c||'#666'; }
        async function fetchWorkers(){
            listBox.innerHTML='<div style="text-align:center;color:#888;font-size:.9em">טוען...</div>';
            try {
                const r = await fetch('/api/worker-names'); if(!r.ok) throw new Error(r.status);
                const data = await r.json();
                const arr = (data.workers||[]).slice();
                listBox.innerHTML = arr.map(w=>`<div data-name="${w.name.replace(/"/g,'&quot;')}" data-id="${w.id||''}" style="display:flex;align-items:center;gap:6px;padding:4px 2px;border-bottom:1px solid #eee;">`+
                    `<span style=\"flex:1;overflow:hidden;text-overflow:ellipsis;direction:rtl\">${w.name}</span>`+
                    `<button class=\"del-worker\" data-id=\"${w.id||''}\" data-name=\"${w.name}\" style=\"background:#d32f2f;color:#fff;border:none;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:.75em;\">מחק</button>`+
                `</div>`).join('');
            } catch(e){ listBox.innerHTML='<div style="color:#d32f2f;text-align:center">שגיאה בטעינה</div>'; }
        }
        async function addWorker(){
            const name = newInput.value.trim(); if(!name){ note('חובה להזין שם','#d32f2f'); return; }
            note('שומר...');
            try {
                const token = await ensureToken(); if(!token){ note('לא הוזן אסימון','#d32f2f'); return; }
                const r = await fetch('/api/worker-names',{method:'POST', headers:{'Content-Type':'application/json','x-admin-token':token}, body: JSON.stringify({ name })});
                if(!r.ok) throw new Error(r.status);
                newInput.value=''; await fetchWorkers(); note('נוסף','#2e7d32');
                document.dispatchEvent(new Event('refdata:refresh-requested'));
            } catch(e){ if(e.message==='403'){ sessionStorage.removeItem('__admin_token'); note('אסימון שגוי','#d32f2f'); } else note('נכשל בהוספה','#d32f2f'); }
        }
        async function delWorker(el){
            const name = el.dataset.name; const id=el.dataset.id; if(!confirm('למחוק עובד? '+name)) return;
            note('מוחק...');
            try {
                const token = await ensureToken(); if(!token){ note('לא הוזן אסימון','#d32f2f'); return; }
                const r = await fetch('/api/worker-names/'+encodeURIComponent(id||name), { method:'DELETE', headers:{'x-admin-token':token}});
                if(!r.ok) throw new Error(r.status);
                await fetchWorkers(); note('נמחק','#2e7d32');
                document.dispatchEvent(new Event('refdata:refresh-requested'));
            } catch(e){ if(e.message==='403'){ sessionStorage.removeItem('__admin_token'); note('אסימון שגוי','#d32f2f'); } else note('מחיקה נכשלה','#d32f2f'); }
        }
        async function exportSnapshot(){
            note('מייצא...');
            try {
                const token = await ensureToken(); if(!token){ note('לא הוזן אסימון','#d32f2f'); return; }
                const r = await fetch('/api/worker-names/export',{method:'POST', headers:{'x-admin-token':token}});
                if(!r.ok) throw new Error(r.status);
                note('נשמר לקובץ (workers.json)','#2e7d32');
            } catch(e){ if(e.message==='403'){ sessionStorage.removeItem('__admin_token'); note('אסימון שגוי','#d32f2f'); } else note('ייצוא נכשל','#d32f2f'); }
        }
        btn?.addEventListener('click', ()=>{ dlg.showModal(); fetchWorkers(); });
        addBtn?.addEventListener('click', addWorker);
        newInput?.addEventListener('keydown', e=>{ if(e.key==='Enter') addWorker(); });
        closeBtn?.addEventListener('click', ()=> dlg.close());
        exportBtn?.addEventListener('click', exportSnapshot);
        listBox?.addEventListener('click', e=>{ const b=e.target.closest('.del-worker'); if(b) delWorker(b); });
        document.addEventListener('refdata:refresh-requested', async ()=>{
            try { const ref = await window.apiLayer?.loadReference?.(); if(ref?.workers){ window.workers = ref.workers.map(w=>w.name); window.PROJECT_WORKERS = window.workers; } } catch(_){ }
        });
    })();
    </script>
</body>
</html>
