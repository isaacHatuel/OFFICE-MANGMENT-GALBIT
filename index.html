<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>×’×œ×‘×™×˜ ×”× ×“×¡×”</title>
<!doctype html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>×’×œ×‘×™×˜ ×”× ×“×¡×” - Redirect</title>
    <meta http-equiv="refresh" content="0; url=/index2.html">
    <link rel="canonical" href="/index2.html" />
    <style>body{font-family:Arial,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f5f7fa;color:#333}a{color:#1976d2}</style>
</head>
<body>
    <div>
        <p>××¢×‘×™×¨ ×œ×¢××•×“ ×”×¨××©×™...</p>
        <p><a href="/index2.html">×œ×—×¥ ×›××Ÿ ×× ×œ× ×”×•×¢×‘×¨×ª ××•×˜×•××˜×™×ª</a></p>
    </div>
</body>
</html>
                    <label>×©× ×œ×•×—:<br>
                        <input type="text" name="boardName">
                    </label><br>
                    <label>×©× ×¢×•×‘×“:<br>
                        <select name="worker" id="dialog-worker"></select>
                    </label><br>
                    <label>×¡×˜×˜×•×¡:<br>
                        <select name="status" id="dialog-status"></select>
                    </label><br>
                    <label>×¡×˜×˜×•×¡ ×©×œ×™×œ×™:<br>
                        <select name="neg1" id="dialog-neg1"></select>
                    </label><br>
                    <label>×¡×˜×˜×•×¡ ×©×œ×™×œ×™ 2:<br>
                        <select name="neg2" id="dialog-neg2"></select>
                    </label><br>
                    <label>×¡×˜×˜×•×¡ ×©×œ×™×œ×™ 3:<br>
                        <select name="neg3" id="dialog-neg3"></select>
                    </label><br>
                    <label>×”×¢×¨×•×ª:<br>
                        <input type="text" name="notes">
                    </label><br>
                    <label><input type="checkbox" name="treated"> ×˜×•×¤×œ</label>
                    <label><input type="checkbox" name="delivered"> × ××¡×¨</label>
                    <label><input type="checkbox" name="finished"> ×”×¡×ª×™×™×</label><br><br>
                    <menu style="display:flex;gap:10px;justify-content:flex-end">
                        <button type="submit" id="dialog-save">×”×•×¡×£</button>
                        <button type="button" onclick="closeProjectDialog()">×‘×™×˜×•×œ</button>
                    </menu>
                </form>
            </dialog>
        </div>
        <div class="tab-content" id="tab-1">

<div style="margin-bottom:16px;display:flex;gap:8px;align-items:center">
    <button class="journal-subtab-btn" data-worker="all" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">×”×›×œ</button>
    <button class="journal-subtab-btn" data-worker="×œ×™×“×•×¨" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">×œ×™×“×•×¨</button>
    <button class="journal-subtab-btn" data-worker="×¡×¤×™×¨" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">×¡×¤×™×¨</button>
    <button class="journal-subtab-btn" data-worker="××ª×Ÿ" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">××ª×Ÿ</button>
    <button class="journal-subtab-btn" data-worker="done" style="background:var(--primary-light);border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;">××©×™××•×ª ×©×‘×•×¦×¢×•</button>
        <button id="add-worker-btn" style="background:#b2dfdb;color:#00695c;border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-weight:500;margin-right:12px;">â• ×”×•×¡×£ ×¢×•×‘×“ ×—×“×©</button>
</div>
<!-- ×“×™××œ×•×’ ×”×•×¡×¤×ª ×¢×•×‘×“ ×—×“×© -->
<dialog id="add-worker-dialog">
    <form method="dialog" style="min-width:320px">
        <h3>×”×•×¡×¤×ª ×¢×•×‘×“ ×—×“×©</h3>
        <label>×©× ×”×¢×•×‘×“:<br>
            <input type="text" id="new-worker-name" required style="width:100%;margin-bottom:10px;">
        </label><br>
        <label>×¡×•×’ ×œ×•×’×™×§×”:<br>
            <select id="new-worker-logic" required style="width:100%;margin-bottom:10px;">
                <option value="lidor">×›××• ×œ×™×“×•×¨</option>
                <option value="sapir">×›××• ×¡×¤×™×¨</option>
                <option value="matan">×›××• ××ª×Ÿ</option>
            </select>
        </label><br>
        <menu style="display:flex;gap:10px;justify-content:flex-end;margin-top:18px;">
            <button type="submit" id="add-worker-confirm">×”×•×¡×£</button>
            <button type="button" id="add-worker-cancel">×‘×™×˜×•×œ</button>
        </menu>
    </form>
</dialog>
</div>
<script>
// --- ×“×™× ××™×§×” ×©×œ ×¢×•×‘×“×™× ×—×“×©×™× ---
let customWorkers = JSON.parse(localStorage.getItem('customWorkers') || '[]');
function renderCustomWorkerTabs() {
    // ×”×¡×¨ ×ª×ª-×œ×©×•× ×™×•×ª ×¢×•×‘×“×™× ×“×™× ××™×™× ×§×™×™××•×ª
    document.querySelectorAll('.journal-subtab-btn[data-custom-worker]').forEach(btn => btn.remove());
    const doneBtn = document.querySelector('.journal-subtab-btn[data-worker="done"]');
    customWorkers.forEach(worker => {
        const btn = document.createElement('button');
        btn.className = 'journal-subtab-btn';
        btn.dataset.worker = worker.name;
        btn.dataset.customWorker = '1';
        btn.dataset.logic = worker.logic;
        btn.style.background = 'var(--primary-light)';
        btn.style.border = 'none';
        btn.style.padding = '8px 18px';
        btn.style.borderRadius = '6px';
        btn.style.cursor = 'pointer';
        btn.style.fontWeight = '500';
        btn.innerHTML = `${worker.name} <span title="××—×§ ×¢×•×‘×“" class="remove-worker-btn" style="color:#d32f2f;font-size:1.1em;margin-right:6px;cursor:pointer;">ğŸ—‘ï¸</span>`;
        doneBtn.parentNode.insertBefore(btn, doneBtn);
    });
}

// ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×™×•××Ÿ ××©×™××•×ª ××—×œ×§×ª×™ ×¢× ××¢×§×‘ ×¤×¨×•×™×§×˜×™×
function syncJournalTable(workerFilter = 'all') {
    const tbody = document.querySelector('#tasks-journal-table tbody');
    tbody.innerHTML = '';
    // ×˜×¢×Ÿ ×¢×¨×›×™× ×©××•×¨×™× ××”-localStorage
    let journalData = {};
    try {
        journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
    } catch (e) { journalData = {}; }

    // ×©××™×¨×” ×¢×œ ×¢×¨×›×™× ×§×™×™××™× ×’× ×× ××¤×ª×— ×”×©×•×¨×” ×”×©×ª× ×” (×œ××©×œ ×©×™× ×•×™ ×©× ×œ×§×•×—, ×¤×¨×•×™×§×˜, ×œ×•×—, ×ª××¨×™×š)
    // × ×‘× ×” ××¢×¨×š ×©×œ ×›×œ ×”××¤×ª×—×•×ª ×”×™×©× ×™× ×¢× ×”×¤×™×¨×•×§ ×©×œ×”×
    const oldKeysArr = [];
    for (const key in journalData) {
        const parts = key.split('|');
        if (parts.length >= 4) {
            oldKeysArr.push({key, parts});
        }
    }
    // ××™×¡×•×£ ×›×œ ×”×©×•×¨×•×ª ×××¢×§×‘ ×¤×¨×•×™×§×˜×™× (×¤×¢×™×œ×™× + ×”×¡×ª×™×™××•)
    const activeRows = document.querySelectorAll('#projects-table-active tbody tr');
    const doneRows = document.querySelectorAll('#projects-table-done tbody tr');
    // ×œ×•×’×™×§×ª select ×œ×¢××•×“×•×ª 7-13 (×¢×•×‘×“×™× ×‘×œ×‘×“, ×›×•×œ×œ "×”×¡×ª×™×™×" ×¨×§ ×œ××ª×Ÿ)
    // ××ª×Ÿ: ××¤×©×¨ ×œ×‘×—×•×¨ '×”×¡×ª×™×™×' ×‘×›×œ ×¢××•×“×” 7-13
    // ×œ×•×’×™×§×ª select ××™×•×—×“×ª ×œ×œ×™×“×•×¨ ×‘×¢××•×“×ª ×©×¨×˜×•×˜ (7)
    const selectHtml = (val, isMatan, colIdx, isLidor) => {
        let opts = `<option value=""></option><option${val==="×œ×™×“×•×¨"?" selected":''}>×œ×™×“×•×¨</option><option${val==="×¡×¤×™×¨"?" selected":''}>×¡×¤×™×¨</option><option${val==="××ª×Ÿ"?" selected":''}>××ª×Ÿ</option>`;
        if (isMatan) {
            opts += `<option${val==="×”×¡×ª×™×™×"?" selected":''}>×”×¡×ª×™×™×</option>`;
        }
        // ×œ×•×’×™×§×” ×œ×œ×™×“×•×¨ ×‘×¢××•×“×ª ×©×¨×˜×•×˜ ×‘×œ×‘×“
        if (isLidor && colIdx === 7) {
            opts += `<option${val==="×‘××™×©×•×¨ ×œ×§×•×—"?" selected":''}>×‘××™×©×•×¨ ×œ×§×•×—</option>`;
            if (val === "×‘××™×©×•×¨ ×œ×§×•×—" || val === "×××•×©×¨ ×œ×‘×™×¦×•×¢") {
                opts += `<option${val==="×××•×©×¨ ×œ×‘×™×¦×•×¢"?" selected":''}>×××•×©×¨ ×œ×‘×™×¦×•×¢</option>`;
            }
        }
        return `<select class="journal-worker-select">${opts}</select>`;
    };
    // ××™×¤×•×™ ×‘×™×Ÿ ××™× ×“×§×¡ ×¢××•×“×” ×œ×©× ×”×¢××•×“×” (×›×¤×™ ×©××•×¤×™×¢ ×‘-th)
    const colIndexToHeader = {
        7: '×©×¨×˜×•×˜',
        8: '××“×‘×§×•×ª',
        9: '××”×“×§×™×',
        10: '×’×™×“×™×',
        11: '×©×œ×˜×™×',
        12: '×”×¨×›×‘×”',
        13: 'AM'
    };
    // ×ª×ª-×œ×©×•× ×™×ª ××©×™××•×ª ×©×‘×•×¦×¢×•: ×©×•×¨×•×ª "×××•×©×¨ ×œ×‘×™×¦×•×¢" ×‘×œ×™×“×•×¨/×©×¨×˜×•×˜ ××• "×”×¡×ª×™×™×" ×‘××ª×Ÿ/×¡×¤×™×¨
    if (workerFilter === 'done') {
        for (const key in journalData) {
            const rowData = journalData[key];
            let hasDone = false;
            let isLidorApproved = false;
            // ×œ×™×“×•×¨: ×¨×§ ×× col7 == "×××•×©×¨ ×œ×‘×™×¦×•×¢"
            if (rowData && rowData[`col7`] === '×××•×©×¨ ×œ×‘×™×¦×•×¢') {
                hasDone = true;
                isLidorApproved = true;
            }
            // ××ª×Ÿ/×¡×¤×™×¨: ×× col7-13 == "×”×¡×ª×™×™×"
            for (let i = 7; i <= 13; i++) {
                if (rowData && rowData[`col${i}`] === '×”×¡×ª×™×™×') {
                    hasDone = true;
                }
            }
            if (hasDone) {
                const parts = key.split('|');
                const row = document.createElement('tr');
                let html = '';
                html += `<td>${parts[0]}</td>`;
                html += `<td>${parts[1]}</td>`;
                html += `<td>${parts[2]}</td>`;
                html += `<td>${parts[3]}</td>`;
                html += `<td></td><td></td><td></td>`;
                for (let i = 7; i <= 13; i++) {
                    let val = rowData && rowData[`col${i}`];
                    // ×œ×™×“×•×¨/×©×¨×˜×•×˜/×××•×©×¨ ×œ×‘×™×¦×•×¢: ×”×¦×’ ×•×™ ×™×¨×•×§
                    if (i === 7 && val === '×××•×©×¨ ×œ×‘×™×¦×•×¢' && isLidorApproved) {
                        html += `<td data-col="7"><button class="done-check-btn-lidor" title="×”×—×–×¨ ×œ××™×©×•×¨ ×œ×§×•×—" style="background:none;border:none;cursor:pointer;"><span style="color:green;font-size:1.5em;">âœ”ï¸</span></button></td>`;
                    } else if (val === '×”×¡×ª×™×™×' && i >= 8) {
                        html += `<td data-col="${i}"><button class="done-check-btn" title="×”×¢×‘×¨ ×œ××©×™××•×ª ×©×‘×•×¦×¢×•" style="background:none;border:none;cursor:pointer;"><span style="color:green;font-size:1.5em;">âœ”ï¸</span></button></td>`;
                    } else if (val === '×”×¡×ª×™×™×') {
                        html += `<td data-col="${i}">×”×¡×ª×™×™×</td>`;
                    } else {
                        html += `<td data-col="${i}"></td>`;
                    }
                }
                row.innerHTML = html;
                tbody.appendChild(row);
            }
        }
        // ×××–×™×Ÿ ×œ×›×¤×ª×•×¨×™ ×•×™ ×™×¨×•×§ ×œ×™×“×•×¨
        tbody.querySelectorAll('.done-check-btn-lidor').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const tr = btn.closest('tr');
                const tds = tr.querySelectorAll('td');
                const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
                let journalData = {};
                try {
                    journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
                } catch (e) { journalData = {}; }
                if (!journalData[key]) journalData[key] = {};
                // ×”×—×–×¨ ×œ"×‘××™×©×•×¨ ×œ×§×•×—"
                journalData[key][`col7`] = '×‘××™×©×•×¨ ×œ×§×•×—';
                localStorage.setItem('journalTasks', JSON.stringify(journalData));
                syncJournalTable('done');
                setTimeout(() => {
                    document.querySelector('.journal-subtab-btn[data-worker="lidor-approval"]').click();
                }, 150);
            });
        });
        // ×××–×™×Ÿ ×œ×›×¤×ª×•×¨×™ ×•×™ ×™×¨×•×§ ×¨×’×™×œ×™× (××ª×Ÿ/×¡×¤×™×¨)
        tbody.querySelectorAll('.done-check-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const tr = btn.closest('tr');
                const tds = tr.querySelectorAll('td');
                const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
                const td = btn.closest('td');
                const colIdx = parseInt(td.getAttribute('data-col'));
                let journalData = {};
                try {
                    journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
                } catch (e) { journalData = {}; }
                if (!journalData[key]) journalData[key] = {};
                journalData[key][`col${colIdx}`] = '××ª×Ÿ';
                localStorage.setItem('journalTasks', JSON.stringify(journalData));
                syncJournalTable('done');
                setTimeout(() => {
                    document.querySelector('.journal-subtab-btn[data-worker="××ª×Ÿ"]').click();
                }, 150);
            });
        });
        return;
    }
    // ×ª×ª ×œ×©×•× ×™×ª ×œ×™×“×•×¨: ×¨×’×™×œ, "×‘××™×©×•×¨ ×œ×§×•×—", "×××•×©×¨ ×œ×‘×™×¦×•×¢" ×•×’× ×¢×•×‘×“×™× ×“×™× ××™×™×
    let isLidorApproval = false;
    if (workerFilter === 'lidor-approval') isLidorApproval = true;
    // ×‘×“×•×§ ×× ×–×” ×¢×•×‘×“ ×“×™× ××™
    let customWorkerLogic = null;
    if (customWorkers.some(w => w.name === workerFilter)) {
      customWorkerLogic = customWorkers.find(w => w.name === workerFilter).logic;
    }
    [...activeRows, ...doneRows].forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length >= 4) {
            const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
            let rowData = journalData[key];
            if (!rowData) {
                for (const old of oldKeysArr) {
                    let matchCount = 0;
                    for (let i = 0; i < 4; i++) {
                        if (old.parts[i] === tds[i].innerText) matchCount++;
                    }
                    if (matchCount === 3) {
                        rowData = journalData[old.key];
                        journalData[key] = rowData;
                        delete journalData[old.key];
                        localStorage.setItem('journalTasks', JSON.stringify(journalData));
                        break;
                    }
                }
            }
            // ×œ×•×’×™×§×”: ×œ×™×“×•×¨ ×¨×’×™×œ - ×©×•×¨×•×ª col7=="×œ×™×“×•×¨"; ×œ×™×“×•×¨/×‘××™×©×•×¨ ×œ×§×•×— - col7=="×‘××™×©×•×¨ ×œ×§×•×—"; ×œ×™×“×•×¨/×××•×©×¨ ×œ×‘×™×¦×•×¢ - col7=="×××•×©×¨ ×œ×‘×™×¦×•×¢"
            let showRow = true;
            if (workerFilter === '×œ×™×“×•×¨') {
                showRow = false;
                if (rowData && (rowData[`col7`] === '×œ×™×“×•×¨' || rowData[`col7`] === '×‘××™×©×•×¨ ×œ×§×•×—')) showRow = true;
            } else if (workerFilter === 'lidor-approval') {
                showRow = false;
                if (rowData && rowData[`col7`] === '×‘××™×©×•×¨ ×œ×§×•×—') showRow = true;
            } else if (workerFilter === '××ª×Ÿ' || workerFilter === '×¡×¤×™×¨') {
                showRow = false;
                for (let i = 7; i <= 13; i++) {
                    let val = rowData && rowData[`col${i}`];
                    if (val === workerFilter || (workerFilter === '××ª×Ÿ' && val === '×”×¡×ª×™×™×')) {
                        showRow = true;
                        break;
                    }
                }
            } else if (customWorkerLogic) {
                // ×œ×•×’×™×§×” ×“×™× ××™×ª ×œ×¢×•×‘×“ ×—×“×©
                showRow = false;
                if (customWorkerLogic === 'lidor') {
                  if (rowData && (rowData[`col7`] === workerFilter || rowData[`col7`] === '×‘××™×©×•×¨ ×œ×§×•×—')) showRow = true;
                } else if (customWorkerLogic === 'sapir') {
                  for (let i = 7; i <= 13; i++) {
                    let val = rowData && rowData[`col${i}`];
                    if (val === workerFilter) {
                      showRow = true;
                      break;
                    }
                  }
                } else if (customWorkerLogic === 'matan') {
                  for (let i = 7; i <= 13; i++) {
                    let val = rowData && rowData[`col${i}`];
                    if (val === workerFilter || val === '×”×¡×ª×™×™×') {
                      showRow = true;
                      break;
                    }
                  }
                }
            } else if (workerFilter !== 'all') {
                showRow = false;
                for (let i = 7; i <= 13; i++) {
                    let val = rowData && rowData[`col${i}`];
                    if (val === workerFilter) {
                        showRow = true;
                        break;
                    }
                }
            }
            if (showRow) {
                const row = document.createElement('tr');
                let html = '';
                html += `<td>${tds[0].innerText}</td>`;
                html += `<td>${tds[1].innerText}</td>`;
                html += `<td>${tds[2].innerText}</td>`;
                html += `<td>${tds[3].innerText}</td>`;
                html += `<td></td><td></td><td></td>`;
                for (let i = 7; i <= 13; i++) {
                    let workerVal = (rowData && rowData[`col${i}`]) || '';
                    const isMatan = (workerFilter === '××ª×Ÿ' || (customWorkerLogic === 'matan'));
                    const isLidor = (workerFilter === '×œ×™×“×•×¨' || workerFilter === 'lidor-approval' || customWorkerLogic === 'lidor');
                    // ×”×¦×’×ª ×•×™ ×™×¨×•×§ ×‘×›×œ ×ª×ª-×œ×©×•× ×™×ª ×× ×”××©×™××” ×‘×•×¦×¢×” ("×”×¡×ª×™×™×" ××• "×××•×©×¨ ×œ×‘×™×¦×•×¢")
                    if ((i === 7 && workerVal === '×××•×©×¨ ×œ×‘×™×¦×•×¢') || (i >= 8 && workerVal === '×”×¡×ª×™×™×')) {
                        // ×œ×™×“×•×¨/×©×¨×˜×•×˜/×××•×©×¨ ×œ×‘×™×¦×•×¢: ×”×¦×’ ×•×™ ×™×¨×•×§ ×¢× ×›×¤×ª×•×¨ ×¨×§ ×‘×ª×ª-×œ×©×•× ×™×ª ××©×™××•×ª ×©×‘×•×¦×¢×•, ×‘×©××¨ ×ª×ª-×œ×©×•× ×™×•×ª ×”×¦×’ ××™×™×§×•×Ÿ ×‘×œ×‘×“
                        if (workerFilter === 'done') {
                            if (i === 7 && workerVal === '×××•×©×¨ ×œ×‘×™×¦×•×¢') {
                                html += `<td data-col="7"><button class="done-check-btn-lidor" title="×”×—×–×¨ ×œ××™×©×•×¨ ×œ×§×•×—" style="background:none;border:none;cursor:pointer;"><span style="color:green;font-size:1.5em;">âœ”ï¸</span></button></td>`;
                            } else {
                                html += `<td data-col="${i}"><button class="done-check-btn" title="×”×¢×‘×¨ ×œ××©×™××•×ª ×©×‘×•×¦×¢×•" style="background:none;border:none;cursor:pointer;"><span style="color:green;font-size:1.5em;">âœ”ï¸</span></button></td>`;
                            }
                        } else {
                            html += `<td data-col="${i}"><span style="color:green;font-size:1.5em;">âœ”ï¸</span></td>`;
                        }
                    } else {
                        html += `<td data-col="${i}"></td>`;
                    }
                }
                row.innerHTML = html;
                tbody.appendChild(row);
                // ××œ× select ×‘×›×œ ×¢××•×“×” 7-13 (×¨×§ ×× ×œ× ×‘×•×¦×¢)
                for (let i = 7; i <= 13; i++) {
                    const td = row.querySelector(`td[data-col="${i}"]`);
                    if (!td) continue;
                    let workerVal = (rowData && rowData[`col${i}`]) || '';
                    const isMatan = (workerFilter === '××ª×Ÿ' || (customWorkerLogic === 'matan'));
                    const isLidor = (workerFilter === '×œ×™×“×•×¨' || workerFilter === 'lidor-approval' || customWorkerLogic === 'lidor');
                    // ×× ×›×‘×¨ ×‘×•×¦×¢, ××œ ×ª×¦×™×’ select
                    if (!((i === 7 && workerVal === '×××•×©×¨ ×œ×‘×™×¦×•×¢') || (i >= 8 && workerVal === '×”×¡×ª×™×™×'))) {
                        td.innerHTML = selectHtml(workerVal, isMatan, i, isLidor);
                    }
                }
            }
        }
    });
    // ×××–×™×Ÿ ×œ×©×™× ×•×™×™× ×‘×ª××™ select ×‘×™×•××Ÿ ××©×™××•×ª ××—×œ×§×ª×™
    tbody.querySelectorAll('.journal-worker-select').forEach((sel, idx) => {
        sel.addEventListener('change', function(e) {
            const tr = sel.closest('tr');
            const tds = tr.querySelectorAll('td');
            const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
            let journalData = {};
            try {
                journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
            } catch (e) { journalData = {}; }
            if (!journalData[key]) journalData[key] = {};
            let colIdx = Array.from(tr.children).indexOf(sel.parentElement);
            journalData[key][`col${colIdx}`] = sel.value;
            localStorage.setItem('journalTasks', JSON.stringify(journalData));
            // ×œ×•×’×™×§×” ××™×•×—×“×ª ×œ×œ×™×“×•×¨/×©×¨×˜×•×˜
            const activeSubtab = document.querySelector('.journal-subtab-btn[style*="background: var(--primary)"]');
            if (activeSubtab && activeSubtab.dataset.worker === '×œ×™×“×•×¨' && colIdx === 7 && sel.value === '×‘××™×©×•×¨ ×œ×§×•×—') {
                setTimeout(() => {
                    document.querySelector('.journal-subtab-btn[data-worker="lidor-approval"]').click();
                }, 100);
            } else if (activeSubtab && activeSubtab.dataset.worker === 'lidor-approval' && colIdx === 7 && sel.value === '×××•×©×¨ ×œ×‘×™×¦×•×¢') {
                setTimeout(() => {
                    document.querySelector('.journal-subtab-btn[data-worker="done"]').click();
                }, 100);
            } else if (activeSubtab && activeSubtab.dataset.worker === '××ª×Ÿ' && sel.value === '×”×¡×ª×™×™×') {
                setTimeout(() => {
                    document.querySelector('.journal-subtab-btn[data-worker="done"]').click();
                }, 100);
            }
        });
    });

    // ×œ×•×’×™×§×ª ×©××™×¨×ª × ×ª×•× ×™× ×¢×‘×•×¨ ×¢××•×“×•×ª 4,5,6 (××¡ ×¢×‘×•×“×”-×ª×›× ×™×ª, ×›××•×ª, ×”×¢×¨×•×ª ×œ×œ×•×—) ×•×¢××•×“×•×ª 7-13 (×©×¨×˜×•×˜, ××“×‘×§×•×ª, ××”×“×§×™× ×•×›×•')
    tbody.querySelectorAll('tr').forEach(tr => {
        // ×¢××•×“×•×ª 4,5: ××¡ ×¢×‘×•×“×”-×ª×›× ×™×ª, ×›××•×ª
        [4,5].forEach(colIdx => {
            const td = tr.children[colIdx];
            if (!td) return;
            // ×”×¦×’×ª ×¢×¨×š ×©××•×¨ ×× ×§×™×™×
            const tds = tr.querySelectorAll('td');
            const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
            let journalData = {};
            try {
                journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
            } catch (e) { journalData = {}; }
            if (journalData[key] && journalData[key][`col${colIdx}`]) {
                td.innerText = journalData[key][`col${colIdx}`];
            }
            td.ondblclick = function(e) {
                if (td.querySelector('input')) return;
                const oldVal = td.innerText;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = oldVal;
                input.style.width = '95%';
                td.innerText = '';
                td.appendChild(input);
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
                input.onblur = input.onchange = function() {
                    td.innerText = input.value;
                    // ×©××™×¨×” ×œ-localStorage
                    const tds = tr.querySelectorAll('td');
                    const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
                    let journalData = {};
                    try {
                        journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
                    } catch (e) { journalData = {}; }
                    if (!journalData[key]) journalData[key] = {};
                    journalData[key][`col${colIdx}`] = input.value;
                    localStorage.setItem('journalTasks', JSON.stringify(journalData));
                };
                input.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter') {
                        input.blur();
                    }
                });
            };
        });

        // ×¢××•×“×” 6: ×”×¢×¨×•×ª ×œ×œ×•×—
        const notesTd = tr.children[6];
        if (notesTd) {
            notesTd.classList.add('journal-notes-cell');
            // ×”×¦×’×ª ×¢×¨×š ×©××•×¨ ×× ×§×™×™×
            const tds = tr.querySelectorAll('td');
            const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
            let journalData = {};
            try {
                journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
            } catch (e) { journalData = {}; }
            if (journalData[key] && journalData[key][`col6`]) {
                notesTd.innerText = journalData[key][`col6`];
            }
            // ××¡×’×¨×ª ××“×•××” ×× ×™×© ×˜×§×¡×˜
            if (notesTd.innerText && notesTd.innerText.trim() !== '') {
                notesTd.classList.add('has-notes');
            } else {
                notesTd.classList.remove('has-notes');
            }
            notesTd.ondblclick = function(e) {
                // ×™×¦×™×¨×ª ×“×™××œ×•×’ ×× ×œ× ×§×™×™×
                let dialog = document.getElementById('journal-notes-dialog');
                if (!dialog) {
                    dialog = document.createElement('dialog');
                    dialog.id = 'journal-notes-dialog';
                    dialog.innerHTML = `
                        <form method="dialog" style="min-width:340px">
                            <h3>×¢×¨×™×›×ª ×”×¢×¨×•×ª ×œ×œ×•×—</h3>
                            <textarea style="width:100%;height:120px;font-size:1.35em;resize:vertical;line-height:1.6;" id="journal-notes-textarea"></textarea>
                            <menu style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
                                <button type="submit">×©××•×¨</button>
                                <button type="button" id="journal-notes-cancel">×‘×™×˜×•×œ</button>
                            </menu>
                        </form>
                    `;
                    document.body.appendChild(dialog);
                }
                const textarea = dialog.querySelector('#journal-notes-textarea');
                textarea.value = notesTd.innerText;
                dialog.showModal();
                textarea.focus();
                // ×©××™×¨×”
                dialog.querySelector('form').onsubmit = function(ev) {
                    ev.preventDefault();
                    notesTd.innerText = textarea.value;
                    // ××¡×’×¨×ª ××“×•××” ×× ×™×© ×˜×§×¡×˜
                    if (textarea.value && textarea.value.trim() !== '') {
                        notesTd.classList.add('has-notes');
                    } else {
                        notesTd.classList.remove('has-notes');
                    }
                    // ×©××™×¨×” ×œ-localStorage
                    const tds = tr.querySelectorAll('td');
                    const key = [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText].join('|');
                    let journalData = {};
                    try {
                        journalData = JSON.parse(localStorage.getItem('journalTasks') || '{}');
                    } catch (e) { journalData = {}; }
                    if (!journalData[key]) journalData[key] = {};
                    journalData[key][`col6`] = textarea.value;
                    localStorage.setItem('journalTasks', JSON.stringify(journalData));
                    dialog.close();
                };
                dialog.querySelector('#journal-notes-cancel').onclick = function() {
                    dialog.close();
                };
            };
        }

        // ×¢××•×“×•×ª 7-13: ×©×¨×˜×•×˜, ××“×‘×§×•×ª, ××”×“×§×™× ×•×›×•' (×©××™×¨×” ×›×‘×¨ ×§×™×™××ª ×‘×œ×•×œ××ª select)
        // ××™×Ÿ ×¦×•×¨×š ×œ×©× ×•×ª ×›××Ÿ
    });
}
// ×§×¨×™××” ×¨××©×•× ×™×ª ×•×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™ ××—×¨×™ ×›×œ ×©×™× ×•×™
window.addEventListener('DOMContentLoaded', function() {
        // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×œ×ª×ª-×œ×©×•× ×™×ª ×œ×™×“×•×¨/×‘××™×©×•×¨ ×œ×§×•×— ×× ×œ× ×§×™×™×
        if (!document.querySelector('.journal-subtab-btn[data-worker="lidor-approval"]')) {
                const lidorBtn = document.querySelector('.journal-subtab-btn[data-worker="×œ×™×“×•×¨"]');
                const approvalBtn = document.createElement('button');
                approvalBtn.className = 'journal-subtab-btn';
                approvalBtn.dataset.worker = 'lidor-approval';
                approvalBtn.style.background = 'var(--primary-light)';
                approvalBtn.style.border = 'none';
                approvalBtn.style.padding = '8px 18px';
                approvalBtn.style.borderRadius = '6px';
                approvalBtn.style.cursor = 'pointer';
                approvalBtn.style.fontWeight = '500';
                approvalBtn.innerText = '×‘××™×©×•×¨ ×œ×§×•×— (×œ×™×“×•×¨)';
                approvalBtn.style.display = 'none'; // start hidden
                lidorBtn.parentNode.insertBefore(approvalBtn, lidorBtn.nextSibling);
        }
        renderCustomWorkerTabs();
        syncJournalTable();
        // ×ª×ª ×œ×©×•× ×™×•×ª ×‘×™×•××Ÿ
        function bindSubtabEvents() {
            const subtabBtns = Array.from(document.querySelectorAll('.journal-subtab-btn'));
            const lidorBtn = document.querySelector('.journal-subtab-btn[data-worker="×œ×™×“×•×¨"]');
            const approvalBtn = document.querySelector('.journal-subtab-btn[data-worker="lidor-approval"]');
            subtabBtns.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                            // ××—×™×§×ª ×¢×•×‘×“ ×“×™× ××™
                            if (e.target.classList.contains('remove-worker-btn')) {
                                const workerName = btn.dataset.worker;
                                if (confirm('×”×× ×œ××—×•×§ ××ª ×”×¢×•×‘×“ ' + workerName + '?')) {
                                    customWorkers = customWorkers.filter(w => w.name !== workerName);
                                    localStorage.setItem('customWorkers', JSON.stringify(customWorkers));
                                    renderCustomWorkerTabs();
                                    bindSubtabEvents();
                                    syncJournalTable('all');
                                }
                                return;
                            }
                            subtabBtns.forEach(b=>b.style.background='var(--primary-light)');
                            btn.style.background = 'var(--primary)';
                            // Show/hide '×‘××™×©×•×¨ ×œ×§×•×— (×œ×™×“×•×¨)' subtab only when '×œ×™×“×•×¨' is active
                            if (btn.dataset.worker === '×œ×™×“×•×¨') {
                                    if (approvalBtn) approvalBtn.style.display = '';
                            } else {
                                    if (approvalBtn) approvalBtn.style.display = 'none';
                            }
                            syncJournalTable(btn.dataset.worker);
                    });
            });
        }
        bindSubtabEvents();
        // ×‘×¨×™×¨×ª ××—×“×œ: ×”×›×œ
        document.querySelector('.journal-subtab-btn[data-worker="all"]').style.background = 'var(--primary)';
        // Hide '×‘××™×©×•×¨ ×œ×§×•×— (×œ×™×“×•×¨)' on load
        const approvalBtn = document.querySelector('.journal-subtab-btn[data-worker="lidor-approval"]');
        if (approvalBtn) approvalBtn.style.display = 'none';

        // ×œ×—×¦×Ÿ ×”×•×¡×¤×ª ×¢×•×‘×“
        document.getElementById('add-worker-btn').onclick = function() {
            const dialog = document.getElementById('add-worker-dialog');
            dialog.showModal();
            dialog.querySelector('#new-worker-name').value = '';
            dialog.querySelector('#new-worker-logic').value = 'lidor';
        };
        document.getElementById('add-worker-cancel').onclick = function() {
            document.getElementById('add-worker-dialog').close();
        };
        document.getElementById('add-worker-dialog').onsubmit = function(ev) {
            ev.preventDefault();
            const name = document.getElementById('new-worker-name').value.trim();
            const logic = document.getElementById('new-worker-logic').value;
            if (!name) return;
            if (customWorkers.some(w => w.name === name)) {
                alert('×¢×•×‘×“ ×‘×©× ×–×” ×›×‘×¨ ×§×™×™×');
                return;
            }
            customWorkers.push({name, logic});
            localStorage.setItem('customWorkers', JSON.stringify(customWorkers));
            document.getElementById('add-worker-dialog').close();
            renderCustomWorkerTabs();
            bindSubtabEvents();
            syncJournalTable(name);
            // ×”×¤×¢×œ ××ª ×”×œ×©×•× ×™×ª ×”×—×“×©×”
            setTimeout(() => {
                const btn = document.querySelector('.journal-subtab-btn[data-worker="'+name+'"]');
                if (btn) {
                    document.querySelectorAll('.journal-subtab-btn').forEach(b=>b.style.background='var(--primary-light)');
                    btn.style.background = 'var(--primary)';
                }
            }, 100);
        };
});
// ×¢×•×˜×£ ××ª ×”×¤×•× ×§×¦×™×•×ª ×”×¨×œ×•×•× ×˜×™×•×ª ×œ×¢×“×›×•×Ÿ ××•×˜×•××˜×™
const origAddProjectRow = window.addProjectRow;
window.addProjectRow = function(data, skipSave) {
    origAddProjectRow(data, skipSave);
    syncJournalTable();
};
const origUpdateProjectRow = window.updateProjectRow;
window.updateProjectRow = function(tr, data) {
    origUpdateProjectRow(tr, data);
    syncJournalTable();
};
const origDeleteProjectRow = window.deleteProjectRow;
window.deleteProjectRow = function(tr) {
    origDeleteProjectRow(tr);
    syncJournalTable();
};
</script>
            <table id="tasks-journal-table">
                <thead>
                    <tr>
                        <th>×ª××¨×™×š</th>
                        <th>×©× ×œ×§×•×—</th>
                        <th>×©× ×¤×¨×•×™×§×˜</th>
                        <th>×©× ×œ×•×—</th>
                        <th>××¡ ×¢×‘×•×“×”-×ª×›× ×™×ª</th>
                        <th>×›××•×ª</th>
                        <th>×”×¢×¨×•×ª ×œ×œ×•×—</th>
                        <th>×©×¨×˜×•×˜</th>
                        <th>××“×‘×§×•×ª</th>
                        <th>××”×“×§×™×</th>
                        <th>×’×™×“×™×</th>
                        <th>×©×œ×˜×™×</th>
                        <th>×”×¨×›×‘×”</th>
                        <th>AM</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="tab-content" id="tab-2">
            <table id="projects-table-done">
                <thead>
                    <tr>
                        <th>×ª××¨×™×š</th>
                        <th>×©× ×œ×§×•×—</th>
                        <th>×©× ×¤×¨×•×™×™×§×˜</th>
                        <th>×©× ×œ×•×—</th>
                        <th>×©× ×¢×•×‘×“</th>
                        <th>×¡×˜×˜×•×¡</th>
                        <th>×¡×˜×˜×•×¡ ×©×œ×™×œ×™</th>
                        <th>×¡×˜×˜×•×¡ ×©×œ×™×œ×™ 2</th>
                        <th>×¡×˜×˜×•×¡ ×©×œ×™×œ×™ 3</th>
                        <th>×”×¢×¨×•×ª</th>
                        <th>×˜×•×¤×œ</th>
                        <th>× ××¡×¨</th>
                        <th>×”×¡×ª×™×™×</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        function showTab(idx) {
            document.querySelectorAll('.tab').forEach((el, i) => {
                el.classList.toggle('active', i === idx);
            });
            document.querySelectorAll('.tab-content').forEach((el, i) => {
                el.classList.toggle('active', i === idx);
            });
        }

        // ×¨×©×™××•×ª × ×¤×ª×—×•×ª ××¢×•×“×›× ×•×ª
        const clients = [
            "×©××•×œ×™×§",
            "×”×—×¥ ×”×‘×•× ×”",
            "×“××”",
            "×”×‘×™×ª ×”×—×›× LOG-IN",
            "××•×¦×¨×™ ×—×©××œ ×¨×‘×™",
            "×¢××™ ×©×¨×•×ª×™ ×—×©××œ",
            "×¢.×.×•. ×‘× ×™×”",
            "××œ ××¨ ×¤×¨×•×™×™×§×˜×™×",
            "×’×¦×œ×¨ ×‘×™×§×¡× ×©×¤× ×¨",
            "×.×.×¨×•×Ÿ",
            "×¤×¡×’×•×ª",
            "×.×©.×™×¨×•×©×œ××™",
            "×—×©××œ ×”×¨×¦×œ",
            "××œ×™×©×™×¨ ×¢×‘×•×“×•×ª ×—×©××œ",
            "×.×©.×¢×•×¦××ª ×”×—×©××œ",
            "×©×ª×™×ª ×”× ×“×¡×” ×‘×¢\"×",
            "×.××•×œ×™×Ÿ ×‘×¢\"×",
            "×›×××œ ×¢×ª×× ××”",
            "××™×”×‘ × ×›××©",
            "×”×¡×¤×œ ×¨×•×¢×™",
            "×.×. × ×™×“×œ",
            "×¨××™ ×¢×‘×•×“×•×ª ×—×©××œ ×•×ª×§×©×•×¨×ª",
            "×¢×™×××“ ×›× ×¢× ×™",
            "×”×¦×‘×™ ×§×™×¨×•×¨ ×•××–×•×’ ××•×™×¨",
            "××‘×™×‘ ××¡×¤×§×” ×˜×›× ×™×ª",
            "×ª×•××¨ ×‘×¨×•×©",
            "×©××œ ×¦×™×•×“ ×˜×›× ×™",
            "×¤×–×” ××—×¨×ª",
            "×—×©××œ ×”×‘×¨×§",
            "×.×¦×•× ×‘×¢\"×",
            "×¢×©×¨ ×—×©××œ ×‘×¢\"×",
            "×“×™×™×‘ ×¢×ª×× ×",
            "×”× ×“×¡×ª ×¡×¤×™×§×”",
            "×’×™× ××©××‘×•×ª",
            "××œ ××™ ×§×‘×œ× ×•×ª",
            "××“×Ÿ ×¡×—×¨",
            "×—.×.××¢×¨×›×•×ª ×—×©××œ",
            "×¢.×™.×”× ×“×¡×ª ××™×",
            "×.×“×’× ×™×",
            "×©×œ×•× ×’×¨×‘×™",
            "×©××œ ×¦×¤×•×Ÿ - ××¢×¨×›×ª ××™×",
            "×—.×¨×××",
            "×–××‘ ×”×•×¨×•×‘×™×¥",
            "××•×¨ ×©×™ ×‘×¢\"×",
            "×¡×•×¤×¨ ××œ×•× ×™",
            "×‘.×.××©××‘×•×ª",
            "×˜×™×‘ ××•×¨",
            "××‘×• ×—×¨×™×¨×™ ×¢××“",
            "×¨×¤×™-×•.×©×™×•×•×§ ×•××¡×¤×§×”",
            "×œ×•×™×§ ×©×™×¨×•×ª×™ ×ª××•×¨×”",
            "×¢××•×¡",
            "×¢×™×¨×™×ª ×ª×œ ××‘×™×‘",
            "× ×¨ ×‘×§×¨×”",
            "×”×× ×™×¢ ××©××‘×•×ª",
            "××•× ×œ×™×§",
            "×•×™× ×‘×¨×’ ××‘×¨×”×",
            "××•×–×™××•×Ÿ ×”××“×¢ ×™×¨×•×©×œ×™×™×",
            "×”×× ×™×¢ ××©××‘×•×ª ×‘×¢\"×",
            "×–×™×™×“",
            "×.×.×ª×©×ª×™×•×ª ×¢×¤×¨ ",
            "×ª×“×”×¨",
            "××™×¡××¢×™×œ",
            "××‘× ×¨ ×¦×“×•×§ ×¤×œ×’×™×",
            "×’×¨×™×Ÿ ×œ×™×™×Ÿ",
            "×¡×•××“ × ××˜×•×¨",
            "×—×©××œ ×× ×©×”",
            "×—×™×™×",
            "×—×©××œ × ×¢××Ÿ ××“×™×",
            "×¦×™×•×Ÿ ×—×•×“×¨×”",
            "×“×•×¡×˜×¨×” ×¢×‘×•×“×•×ª ×—×©××œ",
            "×“× ×™×” ×¡×™×‘×•×¡",
            "×¡×œ×™×œ ×”×× ×•×¢",
            "×—×©××œ ×œ×›×œ",
            "×’×™××• ×“× ×™×”",
            "×¢××¨",
            "×××™×¨ ×¢×‘×•×“×•×ª ×‘× ×™×Ÿ ×Ÿ×ª×¢×©×™×”",
            "××›×•×Ÿ ×•×•×œ×§× ×™",
            "×—××“×Ÿ ×¢×•××¨ ×¡.×¢.×¨ ×—×©××œ",
            "×™.× . ×¢×‘×•×“×•×ª ×—×©××œ × ×¢× ×™×•×¡×£",
            "××œ×˜×§",
            "×©.×¨×.×œ ×‘×¢\"×",
            "××•× ×˜×§ ××¢×¨×›×•×ª ×‘×§×¨×”",
            "× ×˜×•×œ ×¤×“×™×œ",
            "×—×©××œ ××‘×™",
            "×œ×™×™××Ÿ ×¢××™×ª",
            "×©××•××œ ××•×¨ ×—×™×™×",
            "×©.×’×•×–××Ÿ ×•×‘× ×™×•",
            "××•×©×¨×™",
            "×.×× ×¨×’×™×ª ×—×©××œ",
            "×—×©××œ ×”×©×—×¨",
            "×¡.×¨.×™ ",
            "×¨××•×ª ×™×•×“××™×§×” ×™×‘×•× ×™×¦×•×",
            "×™×•× ×™×§ ××¢×¨×›×•×ª",
            "×¨×©×£ ×¢×‘×•×“×•×ª ×—×©××œ",
            "×‘×Ÿ ×©×’×™×",
            "××‘×¨×”× ×©×©×•×Ÿ",
            "××•×¨×™×•×Ÿ",
            "×‘.×§.×¨ ×¤×¨×•×™×§×˜×™× ×‘×¢\"×",
            "×©×•×Ÿ ×¨×•×Ÿ",
            "×©.×.×",
            "×©×¨×¢×‘×™",
            "××‘×• ×œ×™×œ ×—×©××œ",
            "××¨×›×– ×˜×›× ×•×œ×•×’×™×•×ª",
            "×¤×“×™×œ",
            "××©×¨ ×‘×˜×™×˜×• ",
            "××—×œ ××©××‘×•×ª",
            "×™.×© ×—×©××œ ×‘×¢\"×",
            "×¨×•×Ÿ ×©××¢×•×Ÿ ×—×©××œ ×•×ª×§×©×•×¨×ª",
            "×—×©××œ ×–××‘",
            "×’× ×™ ×‘×¨",
            "××•×œ×›×• ×§××¨×™×Ÿ",
            "×.×© ×¤×¨×•×™×§×˜×™×",
            "×•×™×˜×œ×™ ×œ×•× ×’×•",
            "×”×©×¤×œ×ª ××™ ×ª×”×•× LDDWJ",
            "×¢×¨×Ÿ ×œ×‘× ×™ ×‘×¢\"×",
            "×¤×¡×§×¨×™×• ×•×©×•×ª-××©××‘×•×ª ××™× ×‘×¢\"×",
            "×©×™ ×–×™×’×“×•×Ÿ",
            "×“×•×“×• ××¢×¨×›×•×ª ×•××©××‘×•×ª ××™×™×",
            "×¡×§×•×¤ ××ª×›×•×ª - ×”×× ×™×¢ ××©××‘×•×ª",
            "×™× ×™×‘ ×§×˜×Ÿ",
            "×¨×•× ×˜×œ ×”× ×“×¡×”",
            "×™×•×¡×™ ×œ×•×™ ×—×©××œ",
            "×¢×“×Ÿ ×¡×¨×© ×”×ª×§× ×•×ª (××™×›××œ ×”×ª×§× ×•×ª)",
            "×©.××œ ×¦×™×•×“ ×˜×›× ×™ ×‘×¢\"×",
            "×’×¨×™× ×¤×œ×“ ×—×™×™× ××©××‘×•×ª",
            "××¡×˜×œ ××™×–×•×’ ××•×™×¨",
            "××¤×§×•×Ÿ ×‘×§×¨×”",
            "×–×¨× ××™×™× ×‘×¢\"×",
            "×××™×¨ ×©×™×¨×•×ª×™ ×—×©××œ",
            "×’×œ×‘×™×˜ ×”× ×“×¡×” ×‘×¢\"×",
            "×©×™×›×•×Ÿ ×•×‘×™× ×•×™ ×¡×•×œ×œ ×‘×•× ×”",
            "××œ×§×˜×¨×” ME",
            "× ××•×¨ ×”× ×“×¡×ª ×—×©××œ",
            "××‘×™ ××–×¨×—×™",
            "×.×œ. ×™×–××•×ª",
            "××œ×™ ×¨×•×¡××Ÿ",
            "×œ×™×¡×•×’×•×¨×¡×§×™ ×’×¨×’×•×¨×™",
            "× ×•×•×” ×¨×¢×™×” (×.×–. 2006) ×‘×¢\"×",
            "×“×•×¨ ××¢×¨×›×•×ª ×”× ×¢×” ×‘×¢\"×",
            "×‘×˜× ×”× ×“×¡×ª ×—×©××œ",
            "×.×©. ×—×©××œ",
            "×’×¨×™× ×§×• ×× ×¨×’'×™ ×‘×¢\"×",
            "×—×Ÿ ××–×•×œ××™ ×©×™×¨×•×ª×™ ×—×©××œ",
            "×.×œ. ××¨××œ ×”× ×“×¡×ª ××™×–×•×’ ××•×™×¨ ×‘×¢\"×",
            "××©×” ×.×¡ ×—×©××œ",
            "××™×œ× ×™×•× ×§×™×¨×•×¨ ×•××™×–×•×’ ××•×™×¨ ×‘×¢\"×",
            "×—×œ×™×œ ×™×•×¡×£ ×‘×¢\"×",
            "×©×¨×•×Ÿ ×‘×¨××•×Ÿ",
            "×—.×œ.×¦ - ×—×©××œ××™ ×œ×¢×ª ×¦×¨×”",
            "×›×¢×™×Ÿ ×”×—×©××œ",
            "××§×¡×™×™×˜ ×™×©×¨××œ ×¤×¨×•×™×™×§×˜×™× ×‘×¢×",
            "×™× ×™×‘ ×¢××¨",
            "××œ×ª×Ÿ ×”× ×“×¡×” ××–×¨×—×™×ª ×‘×¢×",
            "×§×•× ×˜××œ ××œ×§×˜×¨×•××›× ×™×§×” ×‘×¢×",
            "×©××“×¨ ×”× ×“×¡×” ×•×‘× ×™×™×Ÿ ×‘×¢\"×",
            "××¨×™××œ ×’×‘××™",
            "×“×•×“×• ×©×™×¨×•×ª×™ ×—×©××œ",
            "×©×”× ××©××‘×•×ª ×•×™×¤×¢×ª",
            "×—×‘×¨×ª ×”×’×™×—×•×Ÿ ×‘×¢\"×",
            "×§×•× ×˜×œ ××•×˜××¦×™×” ×•×‘×§×¨×” ×‘×¢\"×",
            "×—×›×™××™××Ÿ ×“× ×™ - ×©×™×¨×•×ª×™ ×—×©××œ",
            "×‘×™×ª ×—×•×œ×™× ×”×œ×œ ×™×¤×”",
            "××œ×“×•×—×” ××¨×§×˜ ×©×™×•×•×§ ××–×•×Ÿ",
            "××œ×§×˜×¨×” ×‘×¢\"×",
            "××™×™.×“×™.××™. ×˜×›× ×•×œ×•×’×™×•×ª ×‘×¢\"× IDE",
            "×§×™× ×’ ×‘×™×¨×™× ×’",
            "×××™×“×Ÿ ×™×¦×•× ×™×‘×•×",
            "××™×ª×Ÿ ×”× ×“×¡×ª ××™× ×‘×¢\"×",
            "×©×¨×•×ª ×”×•×’×Ÿ ×‘×¢\"×",
            "× ×™×¨×œ×˜ ×¦×‘×¢×™× ×‘×¢\"×",
            "AMP",
            "×©××•××œ ××œ××“",
            "××¤×˜×’×•×Ÿ",
            "××©×§×¨×™×˜",
            "×“×•×¨ ××©××‘×•×ª",
            "×¡×¨×’×•×¡×˜×™× ×‘×¢\"×",
            "× ×™×™×˜×™×‘ ×˜×§ ×‘×¢×",
            "×™×•×¡×™×§×•×¨ ×‘×¢\"×",
            "××•×œ ××™ ×•×•×˜×¨ ×‘×¢×",
            "×× ×œ×™×™×˜ ×× ×¨×’×™×” ××ª×—×“×©×ª ×‘×¢\"×",
            "×”×§×•×˜×‘ ×”×¦×¤×•× ×™ ×¤×¨×•×™×™×§×˜×™× ×‘×¢\"×",
            "×.×‘ ×ª×—×–×•×§×” ×•×©×™×¤×•×¦×™×",
            "××¡× ×ª ×—×‘×¨×” ×œ×¢×‘×•×“×•×ª ×§×‘×œ× ×™×•×ª ×‘×¢×",
            "×.×œ ×”× ×“×¡×ª ×—×©××œ ×•×ª××•×¨×”",
            "× ×—×•×©×ª×Ÿ ×’'×•×¨×’' ××”×¨×•×Ÿ",
            "×¦'×™×™× ×”",
            "×–×¨×¢×™× ×˜×›× ×•×œ×•×’×™×•×ª",
            "China rail way tunnel group co. ltd",
            "Bright source"
        ];
        const workers = [
            "××•×”× ×“", "×œ×™×“×•×¨", "×¡×¤×™×¨", "××ª×Ÿ", "××™×¦×™×§", "×™×©×¨××œ", "××œ×™×”×•", "×¢×™×“×•", "×¡××•××œ", "×œ×™××•× ×™×“", "× ×™×§×•×œ××™", "×’×¨×™×©×”", "×¨××•×‘×Ÿ"
        ];
        const statusOptions = [
            "×”×–×× ×” ×—×“×©×”",
            "×‘×ª×›× ×•×Ÿ",
            "×‘×©×¨×˜×•×˜",
            "×‘××™×©×•×¨ ×œ×§×•×—",
            "×××ª×™×Ÿ ×œ×©×™×‘×•×¥",
            "×‘×™×™×¦×•×¨",
            "×‘×‘×“×™×§×”",
            "×××ª×™×Ÿ ×œ××™×¡×•×£"
        ];
        const negativeStatuses = [
            "×—×¡×¨ ×¦×™×•×“",
            "×—×¡×¨ ××‘× ×”",
            "×—×¡×¨ ×©×™×œ×•×˜",
            "×›×©×œ×™× ×‘×‘×“×™×§×”",
            "×××ª×™×Ÿ ×œ AM"
        ];

        // ×“×™××œ×•×’ ×”×•×¡×¤×”/×¢×¨×™×›×”
        let editRow = null;
        function fillDialogSelect(id, options) {
            const sel = document.getElementById(id);
            sel.innerHTML = `<option value="" disabled selected hidden></option>` + options.map(opt => `<option>${opt}</option>`).join('');
        }

        function openProjectDialog(row = null) {
            editRow = row;
            const dialog = document.getElementById('project-dialog');
            const form = document.getElementById('project-form');
            form.reset();
            // ××™×œ×•×™ ×“×™× ××™ ×©×œ ×”×¨×©×™××•×ª
            fillDialogSelect('dialog-client', clients);
            fillDialogSelect('dialog-worker', workers);
            fillDialogSelect('dialog-status', statusOptions);
            fillDialogSelect('dialog-neg1', negativeStatuses);
            fillDialogSelect('dialog-neg2', negativeStatuses);
            fillDialogSelect('dialog-neg3', negativeStatuses);
            document.getElementById('dialog-title').innerText = row ? '×¢×¨×•×š ×¤×¨×•×™×™×§×˜' : '×”×•×¡×£ ×¤×¨×•×™×™×§×˜';
            form.querySelector('#dialog-save').innerText = row ? '×©××•×¨' : '×”×•×¡×£';
            if (row) {
                const cells = row.querySelectorAll('td');
                form.client.value = cells[1].innerText;
                form.projectName.value = cells[2].innerText;
                form.boardName.value = cells[3].innerText;
                form.worker.value = cells[4].innerText;
                form.status.value = cells[5].innerText;
                form.neg1.value = cells[6].innerText;
                form.neg2.value = cells[7].innerText;
                form.neg3.value = cells[8].innerText;
                form.notes.value = cells[9].innerText;
                form.treated.checked = cells[10].querySelector('input').checked;
                form.delivered.checked = cells[11].querySelector('input').checked;
                form.finished.checked = cells[12].querySelector('input').checked;
            }
            dialog.showModal();
        }

        function closeProjectDialog() {
            document.getElementById('project-dialog').close();
            editRow = null;
        }

        document.getElementById('project-form').onsubmit = function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                date: new Date().toLocaleDateString('he-IL'),
                client: form.client.value,
                projectName: form.projectName.value,
                boardName: form.boardName.value,
                worker: form.worker.value,
                status: form.status.value,
                neg1: form.neg1.value,
                neg2: form.neg2.value,
                neg3: form.neg3.value,
                notes: form.notes.value,
                treated: form.treated.checked,
                delivered: form.delivered.checked,
                finished: form.finished.checked
            };
            if (editRow) {
                updateProjectRow(editRow, data);
            } else {
                addProjectRow(data);
            }
            closeProjectDialog();
        };

        function addProjectRow(data, skipSave = false) {
            const tbody = data.finished ? document.querySelector('#projects-table-done tbody') : document.querySelector('#projects-table-active tbody');
            const tr = document.createElement('tr');
            fillProjectRow(tr, data);
            tbody.appendChild(tr);
            if (!skipSave) saveProjectsToStorage();
        }

        function updateProjectRow(tr, data) {
            fillProjectRow(tr, data);
            saveProjectsToStorage();
        }

        function fillProjectRow(tr, data) {
            // notes cell: add class and red border if not empty
            let notesClass = 'project-notes-cell';
            if (data.notes && data.notes.trim() !== '') notesClass += ' has-notes';
            tr.innerHTML = `
                <td>${data.date}</td>
                <td>${data.client}</td>
                <td>${data.projectName}</td>
                <td>${data.boardName}</td>
                <td class="editable-select" data-type="worker">${data.worker}</td>
                <td class="editable-select" data-type="status">${data.status}</td>
                <td class="editable-select" data-type="neg1">${data.neg1}</td>
                <td class="editable-select" data-type="neg2">${data.neg2}</td>
                <td class="editable-select" data-type="neg3">${data.neg3}</td>
                <td class="${notesClass}">${data.notes || ''}</td>
                <td><input type="checkbox" ${data.treated ? 'checked' : ''} onchange="onCheckBoxChange(this)"></td>
                <td><input type="checkbox" ${data.delivered ? 'checked' : ''} onchange="onCheckBoxChange(this)"></td>
                <td><input type="checkbox" ${data.finished ? 'checked' : ''} onchange="onCheckBoxChange(this)"></td>
                <td>
                    <button class="action-btn edit-btn" title="×¢×¨×•×š" onclick="openProjectDialog(this.parentElement.parentElement)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align:middle"><path d="M3 17.25V21h3.75l11.06-11.06-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></svg>
                    </button>
                    <button class="action-btn delete-btn" title="××—×§" onclick="deleteProjectRow(this.parentElement.parentElement)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align:middle"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/></svg>
                    </button>
                    <button class="action-btn duplicate-btn" title="×©×›×¤×œ" onclick="duplicateProjectRow(this.parentElement.parentElement)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align:middle"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z" fill="currentColor"/></svg>
                    </button>
                </td>
            `;
        }
        // ×“×™××œ×•×’ ×¢×¨×™×›×ª ×”×¢×¨×•×ª ×‘××¢×§×‘ ×¤×¨×•×™×§×˜×™× (×¤×¢×™×œ×™× ×•×”×¡×ª×™×™××•)
        function enableProjectNotesDialog(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            table.addEventListener('dblclick', function(e) {
                const td = e.target.closest('.project-notes-cell');
                if (!td) return;
                const tr = td.parentElement;
                // ×™×¦×™×¨×ª ×“×™××œ×•×’ ×× ×œ× ×§×™×™×
                let dialog = document.getElementById('project-notes-dialog');
                if (!dialog) {
                    dialog = document.createElement('dialog');
                    dialog.id = 'project-notes-dialog';
                    dialog.innerHTML = `
                        <form method="dialog" style="min-width:340px">
                            <h3>×¢×¨×™×›×ª ×”×¢×¨×•×ª</h3>
                            <textarea style="width:100%;height:120px;font-size:1.35em;resize:vertical;line-height:1.6;" id="project-notes-textarea"></textarea>
                            <menu style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
                                <button type="submit">×©××•×¨</button>
                                <button type="button" id="project-notes-cancel">×‘×™×˜×•×œ</button>
                            </menu>
                        </form>
                    `;
                    document.body.appendChild(dialog);
                }
                const textarea = dialog.querySelector('#project-notes-textarea');
                textarea.value = td.innerText;
                dialog.showModal();
                textarea.focus();
                // ×©××™×¨×”
                dialog.querySelector('form').onsubmit = function(ev) {
                    ev.preventDefault();
                    td.innerText = textarea.value;
                    // ××¡×’×¨×ª ××“×•××” ×× ×™×© ×˜×§×¡×˜
                    if (textarea.value && textarea.value.trim() !== '') {
                        td.classList.add('has-notes');
                    } else {
                        td.classList.remove('has-notes');
                    }
                    // ×©××™×¨×” ×œ-localStorage
                    saveProjectsToStorage();
                    dialog.close();
                };
                dialog.querySelector('#project-notes-cancel').onclick = function() {
                    dialog.close();
                };
            });
        }

        // ×”×¤×¢×œ×ª ×“×™××œ×•×’ ×”×¢×¨×•×ª ×¢×œ ×©×ª×™ ×”×˜×‘×œ××•×ª
        enableProjectNotesDialog('projects-table-active');
        enableProjectNotesDialog('projects-table-done');
        // ×¢×™×¦×•×‘ ×ª× ×”×¢×¨×•×ª ×‘××¢×§×‘ ×¤×¨×•×™×§×˜×™× (×›××• ×‘×™×•××Ÿ)
        const style = document.createElement('style');
        style.innerHTML = `
        #projects-table-active td.project-notes-cell,
        #projects-table-done td.project-notes-cell {
            max-width: 140px;
            min-width: 80px;
            width: 120px;
            max-height: 38px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
            word-break: break-all;
            transition: border 0.2s, border-radius 0.2s;
        }
        #projects-table-active td.project-notes-cell.has-notes,
        #projects-table-done td.project-notes-cell.has-notes {
            border: 2px solid red !important;
            border-radius: 8px !important;
        }
        `;
        document.head.appendChild(style);

        // ×©×™× ×•×™ ××¦×‘ ×•×™ ×‘×˜×•×¤×œ/× ××¡×¨/×”×¡×ª×™×™×
        function onCheckBoxChange(checkbox) {
            const tr = checkbox.closest('tr');
            const tds = tr.querySelectorAll('td');
            let treated = false, delivered = false, finished = false;
            if (tds[10] && tds[10].querySelector('input')) treated = tds[10].querySelector('input').checked;
            if (tds[11] && tds[11].querySelector('input')) delivered = tds[11].querySelector('input').checked;
            if (tds[12] && tds[12].querySelector('input')) finished = tds[12].querySelector('input').checked;
            const data = {
                date: tds[0].innerText,
                client: tds[1].innerText,
                projectName: tds[2].innerText,
                boardName: tds[3].innerText,
                worker: tds[4].innerText,
                status: tds[5].innerText,
                neg1: tds[6].innerText,
                neg2: tds[7].innerText,
                neg3: tds[8].innerText,
                notes: tds[9].innerText,
                treated,
                delivered,
                finished
            };
            // ×¨×§ ×× ×”×¡×ª×™×™× ×”×©×ª× ×” - ××¢×‘×™×¨×™× ×‘×™×Ÿ ×”×˜×‘×œ××•×ª
            const isDoneTable = tr.closest('table').id === 'projects-table-done';
            if ((isDoneTable && !finished) || (!isDoneTable && finished)) {
                tr.remove();
                addProjectRow(data);
            } else {
                fillProjectRow(tr, data);
            }
            saveProjectsToStorage();
        }

        // ×¢×¨×™×›×” ×™×©×™×¨×” ×©×œ ×ª××™× × ×‘×—×¨×™×
        document.addEventListener('click', function(e) {
            const td = e.target.closest('.editable-select');
            if (!td || td.querySelector('select')) return;
            let options = [];
            switch (td.dataset.type) {
                case 'worker': options = workers; break;
                case 'status': options = statusOptions; break;
                case 'neg1':
                case 'neg2':
                case 'neg3': options = negativeStatuses; break;
            }
            const current = td.textContent;
            const select = document.createElement('select');
            select.innerHTML = `<option value=""${current===''?' selected':''}></option>` + options.map(opt => `<option${opt===current?' selected':''}>${opt}</option>`).join('');
            td.textContent = '';
            td.appendChild(select);
            select.focus();
            select.addEventListener('blur', saveSelectChange);
            select.addEventListener('change', saveSelectChange);
            function saveSelectChange() {
                td.textContent = select.value;
                saveProjectsToStorage();
            }
        });

        function deleteProjectRow(tr) {
            tr.remove();
            saveProjectsToStorage();
        }

        function duplicateProjectRow(tr) {
            const cells = tr.querySelectorAll('td');
            const data = {
                date: new Date().toLocaleDateString('he-IL'),
                client: cells[1].innerText,
                projectName: cells[2].innerText,
                boardName: cells[3].innerText,
                worker: cells[4].innerText,
                status: cells[5].innerText,
                neg1: cells[6].innerText,
                neg2: cells[7].innerText,
                neg3: cells[8].innerText,
                notes: cells[9].innerText,
                treated: cells[10].querySelector('input').checked,
                delivered: cells[11].querySelector('input').checked,
                finished: cells[12].querySelector('input').checked
            };
            addProjectRow(data);
        }

        // ×©××™×¨×” ×•×˜×¢×™× ×” ×-localStorage
        function saveProjectsToStorage() {
            const getRows = (tbody) => Array.from(tbody.querySelectorAll('tr')).map(tr => {
                const cells = tr.querySelectorAll('td');
                return {
                    date: cells[0].innerText,
                    client: cells[1].innerText,
                    projectName: cells[2].innerText,
                    boardName: cells[3].innerText,
                    worker: cells[4].innerText,
                    status: cells[5].innerText,
                    neg1: cells[6].innerText,
                    neg2: cells[7].innerText,
                    neg3: cells[8].innerText,
                    notes: cells[9].innerText,
                    treated: cells[10].querySelector('input').checked,
                    delivered: cells[11].querySelector('input').checked,
                    finished: cells[12].querySelector('input').checked
                };
            });
            const active = getRows(document.querySelector('#projects-table-active tbody'));
            const done = getRows(document.querySelector('#projects-table-done tbody'));
            const projects = [...active, ...done];
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        function loadProjectsFromStorage() {
            const data = localStorage.getItem('projects');
            if (data) {
                const projects = JSON.parse(data);
                projects.forEach(p => addProjectRow(p, true));
            }
        }

        // ×˜×¢×Ÿ ×¤×¨×•×™×§×˜×™× ×‘×©×™×’×•×¨ ×”×“×£
        window.addEventListener('DOMContentLoaded', function() {
            loadProjectsFromStorage();
            syncJournalTable();
        });
    </script>
</body>
</html>


